import streamlit as st
import requests
from bs4 import BeautifulSoup
import PIL.Image
import io
from google import genai

# ConfiguraciÃ³n de pÃ¡gina
st.set_page_config(page_title="Vestidor Virtual AI", page_icon="ðŸ‘•")

# TÃ­tulo e Interfaz limpia
st.title("ðŸ‘• Tu Vestidor Virtual Inteligente")
st.markdown("---")

# Barra lateral para configuraciÃ³n
with st.sidebar:
    st.header("ConfiguraciÃ³n")
    api_key = st.text_input("IngresÃ¡ tu API Key de Gemini:", type="password")

# Campos de entrada en la web
url_producto = st.text_input("1. PegÃ¡ el link de la prenda que te gusta:")
foto_usuario = st.file_uploader("2. SubÃ­ tu foto ðŸ“¸", type=['jpg', 'png', 'jpeg'])

if st.button("Ver cÃ³mo me queda ðŸ˜Ž"):
    if not url_producto or not foto_usuario or not api_key:
        st.error("Â¡Ups! Asegurate de completar todos los campos.")
    else:
        try:
            client = genai.Client(api_key=api_key)
            
            with st.spinner("âœ¨ Analizando el estilo de la prenda..."):
                # LÃ³gica interna de scraping y IA
                res = requests.get(url_producto, headers={'User-Agent': 'Mozilla/5.0'})
                soup = BeautifulSoup(res.text, 'html.parser')
                img_url = soup.find("meta", property="og:image")['content']
                img_prenda = PIL.Image.open(io.BytesIO(requests.get(img_url).content))
                
                # IdentificaciÃ³n de nombre real del objeto
                h1 = soup.find("h1")
                titulo = h1.text.strip().lower() if h1 else "prenda"
                prompt_filtro = f"De este tÃ­tulo: '{titulo}', extrae solo el nombre del objeto. Una palabra."
                nombre_obj = client.models.generate_content(model='gemini-2.0-flash', contents=[prompt_filtro]).text.strip().lower()

                # GeneraciÃ³n
                img_user = PIL.Image.open(foto_usuario)
                instruccion = f"Sustituye la ropa del usuario por la {nombre_obj}. MantÃ©n color y marca exactos."
                
                resultado = client.models.generate_content(
                    model='gemini-2.5-flash-image',
                    contents=[instruccion, img_user, img_prenda]
                )
                
                # Mostrar resultado
                for part in resultado.candidates[0].content.parts:
                    if part.inline_data:
                        final_img = PIL.Image.open(io.BytesIO(part.inline_data.data))
                        st.image(final_img, caption=f"ðŸ”¥ Â¡Esa {nombre_obj} te queda espectacular!")
                        
        except Exception as e:
            st.error(f"Hubo un error tÃ©cnico. VerificÃ¡ el link o la API Key.")

st.info("Nota: Esta es una representaciÃ³n por IA con fines ilustrativos.")